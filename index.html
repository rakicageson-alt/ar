<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR 汉字妙笔</title>
    <!-- 引入 A-Frame 框架 (核心库) -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- 引入 A-Frame Extras (用于一些辅助功能) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
    
    <style>
        /* 简单的 UI 浮层 */
        body { margin: 0; font-family: sans-serif; }
        #overlay {
            position: absolute; z-index: 1000; bottom: 30px; left: 0; width: 100%;
            text-align: center; pointer-events: none; /* 让点击穿透到 AR 场景 */
        }
        .tip-box {
            background: rgba(0, 0, 0, 0.6); color: white; padding: 10px 20px;
            border-radius: 20px; display: inline-block; font-size: 16px;
        }
        /* 针对 iOS 的特殊提示 */
        #ios-warning {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); color: white; z-index: 2000;
            justify-content: center; align-items: center; text-align: center; padding: 20px;
        }
    </style>
</head>

<body>

    <!-- iOS 提示遮罩 -->
    <div id="ios-warning">
        <div>
            <h3>⚠️ 设备提示</h3>
            <p>检测到您使用的是 iOS (iPhone/iPad)</p>
            <p>苹果 Safari 暂不完全支持 WebXR 平面检测。</p>
            <p>建议使用 <b>安卓手机 Chrome 浏览器</b> 体验最佳效果。</p>
            <button onclick="document.getElementById('ios-warning').style.display='none'" style="padding:10px 20px; margin-top:20px;">我就要试</button>
        </div>
    </div>

    <!-- UI 提示 -->
    <div id="overlay">
        <div class="tip-box" id="info-text">正在寻找地面...请左右移动手机</div>
    </div>

    <!-- AR 场景定义 
         webxr="requiredFeatures: hit-test,local-floor" 开启平面检测能力
    -->
    <a-scene webxr="requiredFeatures: hit-test,local-floor" 
             renderer="colorManagement: true;" 
             cursor="rayOrigin: mouse" 
             raycaster="objects: .clickable">

        <!-- 资源库：定义我们要用的笔画 -->
        <a-assets>
            <!-- 这里用 3D 字体模型太慢，我们直接用文字实体，或者简单的几何体代替 -->
        </a-assets>

        <!-- 灯光 -->
        <a-entity light="type: ambient; intensity: 1;"></a-entity>
        <a-entity light="type: directional; intensity: 0.8; position: -1 2 1"></a-entity>

        <!-- 
             AR 光标 (Reticle)：
             这个圆环会自动贴合地面。用户点击时，物体会生成在这个圆环的位置。
        -->
        <a-entity id="reticle"
                  geometry="primitive: ring; radiusInner: 0.15; radiusOuter: 0.2"
                  material="color: #07c160; shader: flat; opacity: 0.8"
                  rotation="-90 0 0"
                  visible="false"
                  ar-hit-test-listener>
        </a-entity>

        <!-- 放置笔画的容器 -->
        <a-entity id="stroke-container"></a-entity>

    </a-scene>

    <script>
        // 检测是否是 iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
            document.getElementById('ios-warning').style.display = 'flex';
        }

        const scene = document.querySelector('a-scene');
        const reticle = document.getElementById('reticle');
        const infoText = document.getElementById('info-text');
        const container = document.getElementById('stroke-container');

        // 笔画列表 (这里用汉字代替，为了视觉效果，随机颜色)
        const strokes = ["一", "丨", "丿", "乀", "口", "日", "中"];
        const colors = ["#FF5733", "#33FF57", "#3357FF", "#F1C40F", "#9B59B6"];
        let clickCount = 0;

        // 核心组件：监听 AR 会话是否准备好
        scene.addEventListener('enter-vr', () => {
            infoText.innerText = "已进入 AR 模式，请缓慢移动手机扫描地面";
        });

        // 自定义组件：监听 Hit Test (平面检测)
        AFRAME.registerComponent('ar-hit-test-listener', {
            init: function () {
                // 当 WebXR 系统在真实世界找到平面位置时触发
                this.el.sceneEl.addEventListener('ar-hit-test-start', () => {
                    this.el.object3D.visible = true; // 显示光环
                    infoText.innerText = "识别成功！点击屏幕放置笔画";
                });
                
                this.el.sceneEl.addEventListener('ar-hit-test-achieved', () => {
                    this.el.object3D.visible = true; 
                });
            },
            tick: function () {
                // 实时检测光环是否可见，如果不可见（没扫到地面），提示用户
                const isVisible = this.el.getAttribute('visible');
                if(!isVisible) {
                    // infoText.innerText = "请寻找地面...";
                }
            }
        });

        // 点击屏幕交互
        // 在 WebXR 中，点击屏幕相当于触发了 scene 的 click 事件
        // 但我们需要获取 reticle (光环) 的当前位置
        window.addEventListener('click', function () {
            // 只有当光环可见时（意味着找到了地面），才允许放置
            if (reticle.getAttribute('visible')) {
                spawnStroke();
            }
        });

        function spawnStroke() {
            // 1. 获取光环当前的坐标和旋转
            const position = reticle.getAttribute('position');
            const rotation = reticle.getAttribute('rotation');

            // 2. 创建一个新的实体 (Entity)
            const strokeEl = document.createElement('a-text');
            
            // 3. 设置内容：轮流取笔画
            const char = strokes[clickCount % strokes.length];
            const color = colors[clickCount % colors.length];
            clickCount++;

            // 4. 设置属性
            strokeEl.setAttribute('value', char);
            strokeEl.setAttribute('color', color);
            strokeEl.setAttribute('align', 'center');
            strokeEl.setAttribute('scale', '5 5 5'); // 放大一点
            
            // 重要：位置要和光环一致
            strokeEl.setAttribute('position', {
                x: position.x,
                y: position.y + 0.1, // 稍微悬浮一点点
                z: position.z
            });

            // 让文字始终面向用户 (Look At Camera)，防止侧面看不清
            strokeEl.setAttribute('look-at', '[camera]');

            // 动画效果 (出现时弹跳一下)
            strokeEl.setAttribute('animation', {
                property: 'scale',
                from: '0 0 0',
                to: '5 5 5',
                dur: 500,
                easing: 'easeOutElastic'
            });

            // 5. 添加到场景
            container.appendChild(strokeEl);
            
            infoText.innerText = `已放置: ${char}`;
        }
    </script>
</body>
</html>