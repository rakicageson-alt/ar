<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ·ä¸Šç”ŸèŠ± AR (è„±å¡æ‚¬æµ®ç‰ˆ)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 50px;
        }
        .tip-box {
            background: rgba(0, 0, 0, 0.6); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 14px; margin-bottom: 10px;
            text-align: center; backdrop-filter: blur(4px);
        }
        .btn {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white; border: none; padding: 15px 40px;
            border-radius: 50px; font-size: 18px; font-weight: bold;
            pointer-events: auto; 
            box-shadow: 0 4px 15px rgba(255, 75, 43, 0.4);
            display: none; /* åˆå§‹éšè— */
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="tip-box" id="status-text">æ­£åœ¨å¯»æ‰¾èŠ±å‰å›¾ç‰‡...</div>
        <button class="btn" id="action-btn" onclick="spawnWord()">ğŸŒ¸ ç‚¹å‡»ç”ŸèŠ±</button>
    </div>

    <!-- 
      AR åœºæ™¯é…ç½® 
      missTolerance: 5 -> å¢åŠ è¿™ä¸ªå€¼å¯ä»¥å®¹å¿è¯†åˆ«å›¾çŸ­æ—¶é—´çš„æŠ–åŠ¨ä¸¢å¤±
    -->
    <a-scene mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001; missTolerance: 5" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">

        <!-- 
           a-camera: å¼€å¯ look-controls (é™€èºä»ª)ï¼Œå®ç°è„±å¡åçš„æ—‹è½¬è¿½è¸ª
        -->
        <a-camera position="0 0 0" look-controls="enabled: true"></a-camera>

        <!-- è¯†åˆ«ç›®æ ‡å®¹å™¨ -->
        <a-entity id="target-anchor" mindar-image-target="targetIndex: 0">
            <!-- è¯†åˆ«åˆ°æ—¶æ˜¾ç¤ºçš„è¾…åŠ©å…‰åœˆ (è¿™ä¸ªå¯ä»¥è·Ÿéšå›¾ç‰‡æ¶ˆå¤±) -->
            <a-ring color="#ff4b2b" radius-inner="0.5" radius-outer="0.55" opacity="0.5" rotation="0 0 0">
                <a-animation attribute="opacity" from="0.5" to="0.1" dur="1000" dir="alternate" repeat="indefinite"></a-animation>
            </a-ring>
        </a-entity>
        
        <!-- 
           ã€å…³é”®ä¿®æ”¹ã€‘ï¼š
           æˆ‘ä»¬ä¸å†æŠŠå­—æ”¾åœ¨ target-anchor é‡Œé¢ï¼Œè€Œæ˜¯ç›´æ¥æ”¾åœ¨ scene ä¸‹é¢ã€‚
           æˆ‘ä»¬é€šè¿‡ä»£ç æŠŠå­—â€œæ¬è¿â€åˆ°å›¾ç‰‡çš„ä½ç½®ã€‚
        -->

    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const statusText = document.getElementById('status-text');
        const actionBtn = document.getElementById('action-btn');
        const anchor = document.getElementById('target-anchor');

        // æµ‹è¯•æ–‡å­— (å»ºè®®æ”¹æˆè‹±æ–‡ä»¥ä¿è¯æ˜¾ç¤ºï¼Œæˆ–è€…ç”¨å›¾ç‰‡)
        const words = ["Flower", "Life", "Bloom", "Art", "Magic"];
        const colors = ["#ff0000", "#ff7f00", "#ffff00", "#00ff00", "#00ffff"];
        
        let count = 0;
        let isTargetFound = false;

        // ç›‘å¬è¯†åˆ«çŠ¶æ€
        anchor.addEventListener("targetFound", event => {
            statusText.innerText = "å·²é”å®šï¼ç§»å¼€ç›¸æœºå­—ä¹Ÿä¸ä¼šæ¶ˆå¤±å“¦";
            actionBtn.style.display = "block";
            isTargetFound = true;
        });

        anchor.addEventListener("targetLost", event => {
            // è„±å¡æ ¸å¿ƒï¼šä¸¢å¤±ç›®æ ‡æ—¶ï¼Œä¸è¦éšè—æŒ‰é’®ï¼Œå…è®¸ç”¨æˆ·ç»§ç»­åœ¨ç©ºä¸­äº¤äº’ï¼ˆå¦‚æœéœ€è¦ï¼‰
            statusText.innerText = "ç›®æ ‡è„±ç¦»ï¼Œç©ºé—´é”å®šä¸­...";
            // actionBtn.style.display = "none"; // æ³¨é‡Šæ‰è¿™è¡Œï¼Œè®©æŒ‰é’®ä¿æŒæ˜¾ç¤º
        });

        function spawnWord() {
            // ä¸ºäº†ä½“éªŒï¼Œå…è®¸åœ¨è„±å¡çŠ¶æ€ä¸‹ç»§ç»­ç”Ÿæˆï¼ˆåŸºäºä¸Šæ¬¡ä½ç½®ï¼‰ï¼Œæˆ–è€…è¦æ±‚å¿…é¡»åœ¨å¡ç‰‡ä¸Š
            // è¿™é‡Œæˆ‘ä»¬è®¾å®šï¼šå¿…é¡»çœ‹åˆ°å¡ç‰‡æ‰èƒ½ç”Ÿæˆç¬¬ä¸€ä¸ªï¼Œä¹‹åéšæ„
            if (!isTargetFound && count === 0) return alert("è¯·å…ˆæ‰«æå›¾ç‰‡å®šä½ï¼");

            const el = document.createElement('a-text');
            const word = words[count % words.length];
            const color = colors[count % colors.length];
            count++;

            // 1. è·å–è¯†åˆ«å›¾å½“å‰çš„ ä¸–ç•Œåæ ‡ (World Position) å’Œ æ—‹è½¬ (Rotation)
            // è¿™æ˜¯è„±å¡çš„å…³é”®ï¼šæˆ‘ä»¬è·å–ç»å¯¹åæ ‡ï¼Œè€Œä¸æ˜¯ç›¸å¯¹åæ ‡
            const worldPos = new THREE.Vector3();
            const worldQuat = new THREE.Quaternion();
            const worldScale = new THREE.Vector3();
            
            anchor.object3D.updateMatrixWorld(); // å¼ºåˆ¶åˆ·æ–°çŸ©é˜µ
            anchor.object3D.matrixWorld.decompose(worldPos, worldQuat, worldScale);

            // 2. è®¾ç½®æ–‡å­—å±æ€§
            el.setAttribute('value', word);
            el.setAttribute('color', color);
            el.setAttribute('align', 'center');
            el.setAttribute('scale', '3 3 3'); // åˆå§‹å¤§å°

            // 3. è®¡ç®—ç”Ÿæˆä½ç½®ï¼šåœ¨è¯†åˆ«å›¾ä¸­å¿ƒçš„åŸºç¡€ä¸Šï¼Œå¢åŠ éšæœºåç§»
            // Zè½´åç§»åŠ å¤§ (0.5 ~ 1.5)ï¼Œå®ç°æ˜æ˜¾çš„â€œæ‚¬æµ®æ„Ÿâ€
            // æ³¨æ„ï¼šMindARçš„å›¾ç‰‡å‚ç›´æ–¹å‘æ˜¯Yï¼Œå‚ç›´äºå›¾ç‰‡æœå¤–æ˜¯Z
            const offsetX = (Math.random() - 0.5) * 1.0; 
            const offsetY = (Math.random() - 0.5) * 1.0;
            const offsetZ = Math.random() * 1.0 + 0.5; // æµ®èµ·é«˜åº¦ 0.5ç±³ åˆ° 1.5ç±³

            // å°†åç§»é‡åº”ç”¨åˆ°ä¸–ç•Œåæ ‡ (è¿™é‡Œåšç®€å•å åŠ ï¼Œæ›´ä¸¥è°¨åº”è¯¥åŸºäºæ—‹è½¬å˜æ¢ï¼Œä½†ç®€å•å åŠ æ•ˆæœå¤Ÿç”¨äº†)
            el.object3D.position.set(
                worldPos.x + offsetX,
                worldPos.y + offsetY,
                worldPos.z + offsetZ 
            );
            
            // è®©æ–‡å­—é¢å‘æ‘„åƒæœº (å§‹ç»ˆçœ‹ç€ç”¨æˆ·)
            el.setAttribute('look-at', '[camera]');

            // 4. ã€å…³é”®ã€‘å°†æ–‡å­—æ·»åŠ åˆ° scene (ä¸–ç•Œ)ï¼Œè€Œä¸æ˜¯ anchor (å›¾ç‰‡)
            // è¿™æ ·å›¾ç‰‡ç§»èµ°åï¼Œå­—ä¾ç„¶åœ¨ä¸–ç•Œåæ ‡ç³»é‡Œä¸åŠ¨
            scene.appendChild(el);

            // 5. åŠ¨ç”»ï¼šä»å›¾ç‰‡è¡¨é¢æµ®èµ·æ¥çš„æ•ˆæœ
            // æˆ‘ä»¬ç”¨ animation ç»„ä»¶åšä¸€ä¸ªâ€œå…¥åœºåŠ¨ç”»â€
            el.setAttribute('animation', {
                property: 'scale',
                from: '0 0 0',
                to: '5 5 5', // æœ€ç»ˆå˜å¾—æ›´å¤§ä¸€ç‚¹
                dur: 1000,
                easing: 'easeOutElastic'
            });
        }
    </script>
</body>
</html>